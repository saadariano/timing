<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shift Scheduler</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-50">

  <div id="app-root" class="max-w-lg mx-auto bg-white min-h-screen shadow-lg relative pb-16"></div>
  <div id="tab-bar-container"></div>
  <div id="modal-container"></div>

  <!-- Firebase scripts (still loaded but won't crash) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // ----------------------------
    // SAFE INITIALIZATION PATCH
    // ----------------------------
    // This part prevents the blank page when Firebase keys are missing
    const firebaseConfig = { projectId: "OFFLINE_MODE" };

    // Create safe mock objects so the rest of the app doesn’t break
    let app = {}, db = {}, auth = {};
    db.collection = () => ({
      doc: () => ({
        collection: () => ({
          onSnapshot: () => {},
          add: async () => {},
          doc: () => ({ delete: async () => {}, update: async () => {} })
        })
      })
    });
    auth.onAuthStateChanged = (cb) => cb({ uid: "offline-user" });
    auth.signInAnonymously = async () => ({ user: { uid: "offline-user" } });

    // ----------------------------
    // FULL APP STATE (unchanged UI)
    // ----------------------------
    const state = {
      activeTab: 'calendar',
      isAuthReady: true,
      userId: 'offline-user',
      shiftTemplates: [
        { id: '1', title: 'Morning Shift', startTime: '08:00', endTime: '16:00', hours: 8, color: '#10b981', symbol: '☀️', isAllDay: false },
        { id: '2', title: 'Night Shift', startTime: '22:00', endTime: '06:00', hours: 8, color: '#3b82f6', symbol: '🌙', isAllDay: false }
      ],
      calendarEntries: [],
      currentDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
      modals: {
        dayAction: { isOpen: false, date: null },
        shiftPicker: { isOpen: false, date: null },
        newShift: { isOpen: false, shiftToEdit: null },
        emojiPicker: { isOpen: false, onSelect: null }
      }
    };

    const appRoot = document.getElementById('app-root');
    const tabBarContainer = document.getElementById('tab-bar-container');
    const modalContainer = document.getElementById('modal-container');

    // ----------------------------
    // HELPER FUNCTIONS
    // ----------------------------
    const getDaysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
    const getFirstDayOfMonth = (y, m) => new Date(y, m, 1).getDay();
    const formatDate = (d) => d.toISOString().split('T')[0];
    const getMonthName = (d) => d.toLocaleString('en-US', { month: 'long' });
    const calculateHours = (start, end) => {
      if (!start || !end) return 0;
      const s = start.split(':').map(Number), e = end.split(':').map(Number);
      const sd = new Date(0, 0, 0, s[0], s[1]), ed = new Date(0, 0, 0, e[0], e[1]);
      if (ed <= sd) ed.setDate(ed.getDate() + 1);
      return Math.round(((ed - sd) / 36e5) * 100) / 100;
    };
    const colorOptions = ['#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#64748b'];
    const emojiOptions = ['☕','☀️','🌙','💼','🏡','📖','⚡','💊','🛠️','🤝','🏃','🍕','🎉','✈️','🛌','🧘','💰','📅','🛒','❤️','💡','☔','🚧','⚙️','📈','📉','📚','🖊️'];

    // ----------------------------
    // RENDER FUNCTIONS (same design)
    // ----------------------------
    function render() {
      let content = '';
      switch (state.activeTab) {
        case 'calendar': content = renderCalendarScreen(); break;
        case 'reports':  content = renderReportsScreen(); break;
        case 'shifts':   content = renderShiftsScreen(); break;
        case 'more':     content = renderMoreScreen(); break;
      }
      appRoot.innerHTML = content;
      tabBarContainer.innerHTML = renderTabBar();
      lucide.createIcons();
    }

    function renderTabBar() {
      const tabs = [
        { name: 'Calendar', icon: 'calendar', value: 'calendar' },
        { name: 'Reports', icon: 'bar-chart-2', value: 'reports' },
        { name: 'Shifts', icon: 'align-left', value: 'shifts' },
        { name: 'More', icon: 'menu', value: 'more' },
      ];
      return `<div class="fixed bottom-0 left-0 right-0 h-16 bg-white border-t flex justify-around shadow-2xl z-20 max-w-lg mx-auto">
        ${tabs.map(t => `
          <button data-action="set-tab" data-tab="${t.value}" class="flex flex-col items-center justify-center text-xs w-1/4 pt-1 ${state.activeTab === t.value ? 'text-indigo-600' : 'text-gray-500'}">
            <div class="p-1 rounded-full ${state.activeTab === t.value ? 'bg-indigo-100/50' : ''}">
              <i data-lucide="${t.icon}" class="h-6 w-6"></i>
            </div>
            <span class="mt-1">${t.name}</span>
          </button>
        `).join('')}
      </div>`;
    }

    function renderCalendarScreen() {
      const { currentDate } = state;
      const y = currentDate.getFullYear(), m = currentDate.getMonth();
      const daysInMonth = getDaysInMonth(y, m);
      const firstDay = (getFirstDayOfMonth(y, m) + 6) % 7;
      const daysOfWeek = ['M','T','W','T','F','S','S'];
      const monthName = getMonthName(currentDate);

      const grid = [];
      for (let i = 0; i < firstDay; i++) grid.push('');
      for (let day = 1; day <= daysInMonth; day++) grid.push(day);

      return `
        <div class="p-4 pb-20">
          <div class="flex justify-between items-center mb-6">
            <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide='chevron-left'></i></button>
            <h1 class="text-2xl font-bold">${monthName} ${y}</h1>
            <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide='chevron-right'></i></button>
          </div>
          <div class="grid grid-cols-7 text-center font-semibold text-sm text-gray-500 mb-2">
            ${daysOfWeek.map(d => `<div>${d}</div>`).join('')}
          </div>
          <div class="grid grid-cols-7 text-center">
            ${grid.map(day => day ?
              `<div class="border p-2 min-h-[70px] ${day === new Date().getDate() ? 'bg-indigo-50' : 'bg-white'}">
                <div>${day}</div>
              </div>` : `<div class="border p-2 bg-gray-50"></div>`).join('')}
          </div>
        </div>`;
    }

    function renderShiftsScreen() {
      return `
        <div class="p-4 pb-20">
          <h1 class="text-3xl font-bold mb-6">Shift Templates</h1>
          <ul class="divide-y">
            ${state.shiftTemplates.map(s => `
              <li class="p-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                  <div class="rounded-full w-9 h-9 flex items-center justify-center text-xl" style="background:${s.color};">${s.symbol}</div>
                  <div>
                    <p class="font-semibold">${s.title}</p>
                    <p class="text-sm text-gray-500">${s.startTime} - ${s.endTime}</p>
                  </div>
                </div>
                <i data-lucide="chevron-right"></i>
              </li>`).join('')}
          </ul>
        </div>`;
    }

    function renderReportsScreen() {
      return `
        <div class="p-4 pb-20 text-center">
          <h1 class="text-3xl font-bold mb-6">Reports</h1>
          <p class="text-gray-500">Offline mode — connect Firebase for data.</p>
        </div>`;
    }

    function renderMoreScreen() {
      return `
        <div class="p-4 pb-20 text-center">
          <h1 class="text-3xl font-bold mb-6">More</h1>
          <p class="text-gray-500">User ID: offline-user</p>
        </div>`;
    }

    function changeMonth(offset) {
      state.currentDate.setMonth(state.currentDate.getMonth() + offset);
      render();
